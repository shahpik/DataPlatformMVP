jobs:
  - deployment: Deploy
    displayName: Deploy Azure Data Services
    environment: '${{ parameters.environment }}'
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureCLI@2
              displayName: Create Resource Group
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  echo "Creating Resource Group"
                  az group create \
                      --name $(ResourceGroup) \
                      --location $(Region)

            - task: AzureCLI@2
              displayName: Create Azure Key Vaults
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  echo "Creating Key Vault for Data"
                  az keyvault create \
                    --location $(Region) \
                    --name $(KeyVaultData) \
                    --resource-group $(ResourceGroup) \
                    --enable-soft-delete false

                  echo "Creating Key Vault for Machine Learning Service"
                  az keyvault create \
                    --location $(region) \
                    --name $(KeyVaultML) \
                    --resource-group $(ResourceGroup) \
                    --enable-soft-delete false

            - task: AzureCLI@2
              displayName: Create Azure Data Factory
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  echo "Creating Azure Data Factory '$(dataFactory)'"
                  az deployment group create \
                        --resource-group $(resourceGroup) \
                        --name "AzureDataFactory" \
                        --template-file "$(Pipeline.Workspace)/deploy/arm/Microsoft.DataFactory/azuredeploy.json" \
                        --parameters \
                            dataFactoryName=$(dataFactory) \
                            workspaceName=$(logAnalyticsWorkspace) \
                            dataFactoryIRName=$(dataFactoryIntegrationRuntime)


            - task: AzureCLI@2
              displayName: Create SQL Server
              inputs:
                    azureSubscription: '${{ parameters.azureServiceConnection }}'
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      echo "Creating SQL Server '$(sqlServerName)'"
                      az deployment group create \
                        --resource-group $(resourceGroup) \
                        --name "SQLServer" \
                        --template-file "$(Pipeline.Workspace)/deploy/arm/Microsoft.SqlServer/azuredeploy.json" \
                        --parameters \
                            sqlServerName=$(sqlServerName) \
                            databaseName=$(sqlServerDataBaseName) \
                            sqlAdministratorLogin=$(sqlServerAdminUserName) \
                            sqlAdministratorLoginPassword=$(sqlServerAdminPassword) \
                            location=$(region) \
                            adTenantID=$(sqlAzureADGroupTenantID) \
                            adObjectID=$(sqlAzureADGroupObjectID) \
                            adLogin=$(sqlAzureADGroupLoginName)



